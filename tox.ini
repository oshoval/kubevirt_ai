[tox]
envlist = format, lint
isolated_build = true
skip_missing_interpreters = true

[testenv]
deps = -r requirements-dev.txt
allowlist_externals = echo, bash
passenv =
    ANTHROPIC_*
    GLOBAL_KUBECONFIG
    KUBECONFIG

[testenv:format]
description = Format code with black and isort, remove unused imports
deps =
    black
    isort
    autoflake
commands =
    echo "ğŸ—‘ï¸  Removing unused imports and variables..."
    bash -c "autoflake --remove-all-unused-imports --remove-unused-variables --in-place main.py pkg/*.py"
    echo "ğŸ“š Sorting imports..."
    bash -c "isort main.py pkg/*.py"
    echo "ğŸ¨ Formatting code with black..."
    bash -c "black --line-length=120 main.py pkg/*.py"
    echo "âœ… Code formatting complete!"

[testenv:lint]
description = Run linting checks with flake8
deps = flake8
commands =
    echo "ğŸ” Running linting checks..."
    bash -c "flake8 main.py pkg/*.py --max-line-length=120 --extend-ignore=E203,W503"
    echo "âœ… Linting checks passed!"

[testenv:type-check]
description = Run type checking with mypy
deps = mypy
commands =
    echo "ğŸ” Running type checks..."
    bash -c "mypy --ignore-missing-imports main.py pkg/*.py"
    echo "âœ… Type checking complete!"

[testenv:test]
description = Run tests with pytest
deps =
    -r requirements.txt
    pytest
    pytest-cov
    pytest-mock
commands =
    echo "ğŸ§ª Running tests..."
    pytest {posargs}
    echo "âœ… Tests complete!"

[testenv:quality]
description = Run essential code quality checks (format and lint, skip type-check)
deps =
    black
    isort
    autoflake
    flake8
commands =
    echo "ğŸ§¹ Running essential code quality checks..."
    {[testenv:format]commands}
    {[testenv:lint]commands}
    echo "ğŸ‰ Essential quality checks passed!"

[testenv:e2e]
description = Run end-to-end tests with BATS
deps =
allowlist_externals = bats
commands =
    echo "ğŸ§ª Running end-to-end tests..."
    bats tests/e2e/test_simple.bats
    echo "âœ… E2E tests complete!"

[testenv:dev]
description = Development environment with all tools
deps = -r requirements-dev.txt
commands = python --version

# Configuration for tools
[flake8]
max-line-length = 120
extend-ignore = E203, W503
exclude =
    .git,
    .tox,
    __pycache__,
    *.egg-info,
    build,
    dist

[tool:isort]
profile = black
line_length = 120
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true

[tool:pytest]
testpaths = tests
python_files = test_*.py *_test.py
python_functions = test_*
addopts =
    --strict-markers
    --strict-config
    --verbose
    -ra
